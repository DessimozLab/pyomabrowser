{% extends "base_entry.html" %}
{% load staticfiles %}
{% block title %}Local synteny of {{ entry.omaid }} across genomes{% endblock %}
{% block meta_description %}Explore the synthenic genes around {{ entry.omaid }} across its orthologs. Find out about highly conserved regions, rearangements, segmental duplications and other evolutionary events in this region{% endblock %}

{% block css_hook %}
{% endblock css_hook %}

{% block js_hook %}

    <script src="{% static 'local_synteny_viewer/local_synteny.js' %}" charset="UTF-8"></script>
    <script src="{% static 'local_synteny_viewer/orthoxml-parser.js' %}" charset="UTF-8"></script>
    <script src="{% static 'js/d3_7_8.js' %}" charset="UTF-8"></script>

{% endblock js_hook %}



{% block contentTab %}

    <div class="container-fluid">

    <div class="row">

        <div class="col" id="synteny_div"  style=" height:calc(100vh - 285px); width:100px">

        </div>



    </div>


</div>

<script>

var find_element = function(o, query, target) {

    if (o["children"]) {

        for (var c in o["children"]) {

            var child = o["children"][c]

            if (child['id'] == query) return o

            target = find_element(child , query, target)

        }

    }
        return target
    }

var go_one_level_upper = function(e){

    if (!e.parent) return e

    if (e.parent.paralog || e.parent.children.length == 1){
        go_one_level_upper(e.parent)
    }

    return e.parent

}

console.log('{{ most_specific_hog.hog_id }} {{ most_specific_hog.level }}')

 $.when($.ajax({url: "/oma/hog/{{ most_specific_hog.hog_id }}/orthoxml/augmented/",dataType: "text"})).then(function(orthoxml) {

     var call_back_hog_detail = function(hog_id){
                var newUrl="{% url 'hog_viewer' 1234567  %}".replace(/1234567/, hog_id);
                window.open(newUrl, "_blank");
            }

    var call_back_hog_local_synteny = function(hog_id){
        var newUrl="{% url 'hog_synteny' 1234567  %}".replace(/1234567/,hog_id);
        window.open(newUrl, "_blank");
    }

    var callback_gene_local_synteny  = function(gene_id){
        var newUrl="{% url 'synteny' 1234567  %}".replace(/1234567/,gene_id);
        window.open(newUrl, "_blank");
    }

     var call_back_gene_detail = function(gene_id){
        var newUrl="{% url 'pairs' 1234567  %}".replace(/1234567/,gene_id);
        window.open(newUrl, "_blank");
    }

     var phog = find_element(OrthoxmlParser.parse(orthoxml),  '{{ entry.omaid }}', false)

     phog = go_one_level_upper(phog)
     phog = go_one_level_upper(phog)

     var hog_id = phog ? phog.id.split('_')[0] : '{{ most_specific_hog.hog_id }}'
     var hog_level =  phog ? phog.species:  '{{ most_specific_hog.level }}'

     var ls = new LocalSyntenyViewer('synteny_div', '{{ entry.omaid }}',  OrthoxmlParser.parse(orthoxml), hog_id, hog_level , call_back_hog_detail, call_back_hog_local_synteny, callback_gene_local_synteny, call_back_gene_detail)
 })

</script>

{% endblock contentTab %}
