{% extends  "core.html" %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block title %}Matrix specifications{% endblock %}

{% block content %}

<style>

    .master-tile{
        background-color: #f8f9fa;
        padding: 30px
    }

    .section-title{
        color:#bbb;
        font-weight: bold;
        font-size: 1.2em !important;

    }

    .section-tile{
        margin-bottom:24px;
    }

    .section-box{
        background-color: #fff;
        padding: 16px;
        box-shadow: 2px 2px 1px #eee;
        border-radius: 4px;
        margin:8px;
    }

    .icon_selector{
        margin-right:8px;
        color:#555;
    }

    .text_selector{
        margin-right:8px;
        color:#555;
    }

    .number-span{margin-left:1em;}

    .axis path, .axis line {
        fill: none;
        stroke: #fff;
    }

    .axis text {
        font-size: 8px;
      }

    .bar {
      }

    .bar:hover {
        fill: rgba(65,193,194,0.4);
      }

    svg text.label {
      fill:black;
      font-weight: 400;
      text-anchor: middle;
    }

    .tooltip {
        background-color: white;
      position: absolute;
      width: auto;
      height: auto;
      pointer-events: none;
}

    .UI_hist{
        position: absolute;
        top: 40px;
        right: 0px;
        width: auto;
        height: auto;
        background-color: white;
        padding:8px;
    }

    .hide_setting
    {
        position: absolute;
        top: 0px;
        right: 0px;
        width: auto;
        height: auto;
        background-color: white;
        padding:8px;
    }

    .grid .tick {
    stroke: lightgrey;
    opacity: 0.7;
}
.grid path {
      stroke-width: 0;
}



</style>



<div class="container-fluid" >

    <div class="row">

        <div class="col-sm-12 col-md-10 col-md-offset-1 master-tile">

            <div class="section-tile">


                <p class="section-title">OMA RELEASE OF {{ rel_name }}</p>


                <div class="section-box">


                    <ul class="list-unstyled">
                        <li><b>Number of species: </b> <span class="number-span"> {{ nb_genome }}</span></li>
                        <li><b>Number of OMA groups: </b> <span class="number-span">????????</span></li>
                        <li><b>Number of proteins: </b> <span class="number-span">{{ nb_prot }}</span></li>
                        <li><b>Proteins with external links: </b> <span class="number-span"> ???? (??.? %)</span></li>
                        <li><b>Gene Ontology: </b> <span class="number-span">???????? entries in ??????? OMA groups</span></li>
                    </ul>


                </div>

            </div>

            <div class="section-tile">


                <p class="section-title">SPECIES INFORMATION


                    <button type="button" id="btree" class="btn btn-default pull-right icon_selector">
                        <span class="glyphicon glyphicon-tree-deciduous pull-right " aria-hidden="true"
                              data-toggle="tooltip" data-placement="top" title="view as species tree" ></span>
                    </button>

                    <button type="button" id="blist"  class="btn btn-default pull-right icon_selector" >
                        <span class="glyphicon glyphicon-list pull-right " aria-hidden="true"
                              data-toggle="tooltip" data-placement="top" title="view as species list" ></span>
                    </button>

                    <button type="button" id="bhist"  class="btn btn-default pull-right icon_selector" >
                        <span class="glyphicon  glyphicon-stats pull-right " aria-hidden="true"
                              data-toggle="tooltip" data-placement="top" title="view as species histogram"></span>
                    </button>

                    <span class="pull-right text_selector">Change the view: </span>

                </p>





                <div class="section-box" id="section_genome">





                        <div class="panel-body" id="genome_panel" style="position: relative; " >

                        </div>

                </div>

            </div>


        </div>

    </div>

</div>

<!-- D3 and D3 Tooltip -->
<script src="{% static "js/d3.v3.min.js" %}" type="text/javascript"></script>
<script src="{% static "js/d3.tip.v0.6.3.js" %}" type="text/javascript"></script>

<!-- Domain Visualisation -->
<script src="{% static "js/domains_vis.js" %}" type="text/javascript"></script>
<link href="{% static "css/domains_vis.css" %}" rel="stylesheet" type="text/css"/>

    <!-- bootstrap-table -->
    <script src="{% static "js/tablehooks.js" %}" type="text/javascript"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/extensions/export/bootstrap-table-export.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/extensions/mobile/bootstrap-table-mobile.min.js"></script>
<script src="{% static "js/tableExport.min.js" %}"></script>


<script>

    update_genome_viewer("bhist");

    // turn on tooltips
    $(function () {
        $('[data-toggle="tooltip"]').tooltip();

        $('.collapse').collapse();

    })

    // get the button and set update genome function
    var btree = document.getElementById("btree");
    btree.addEventListener("click", function(){
        btree.addEventListener("click", update_genome_viewer(this.id));
    });

    var blist = document.getElementById("blist");
    blist.addEventListener("click", function(){
        blist.addEventListener("click", update_genome_viewer(this.id));
        });

    var bhist = document.getElementById("bhist");
    bhist.addEventListener("click", function(){
        bhist.addEventListener("click", update_genome_viewer(this.id));
        });

    function update_genome_viewer(bid){

        // clean current viewer
        var cviewer = document.getElementById("genome_panel");
        cviewer.innerHTML='';
        while (cviewer.firstChild) {
            cviewer.removeChild(cviewer.firstChild);
        }

        // build tree view
        if (bid === "btree") {

            // display under construction
            var under = document.createElement('h3');
            under.innerHTML = "This part is under construction!";
            under.className = "text-center";
            cviewer.appendChild(under);

        }

        // build table view
        else if (bid === "blist") {

            // create empty table
            var tbl = document.createElement('table');
            tbl.id = "genomeTable";
            cviewer.appendChild(tbl);

            // feed it !
            init_table('genomeTable');}

        // build hist view
        else if (bid === "bhist") {

           // create  UI div

            var UI = document.createElement('div');
            UI.className += "UI_hist";

            var UI_col = document.createElement('div');
            UI_col.id = "UI_hist_collapse";
            UI_col.className += "collapse in";
            UI_col.innerHTML += ' <b>Sort by:</b> <form > <input type="radio" name="sort_ui" value="prots" checked> Size<br> <input type="radio" name="sort_ui" value="kingdom" > Kingdom<br>  </form>';
            UI_col.innerHTML += '<b>Show:</b>  <form > <input type="checkbox" name="filter_ui" value="Eukaryota" checked> Eukaryota<br> <input type="checkbox" name="filter_ui" value="Bacteria" checked> Bacteria<br>  <input type="checkbox" name="filter_ui" value="Archaea" checked> Archaea<br>  </form>'

            UI.appendChild(UI_col);
            cviewer.appendChild(UI);



            // create plot div
            var div = document.createElement('div');
            div.id = "hist_div";
            div.style.overflow = "scroll";
            div.style.width = "100%";
            cviewer.appendChild(div);


            var d = document.createElement('div');
            d.innerHTML = '<button type="button" data-toggle="collapse" data-target="#UI_hist_collapse" class="btn btn-default hide_setting">  <span class="glyphicon glyphicon-cog pull-right "  ></span> </button>';
            cviewer.appendChild(d);


            // create legend div
            var div = document.createElement('div');
            div.id = "hist_legend";
            div.style.width = "100%";
            cviewer.appendChild(div);




            (function() {
  var filter_ui_checks = document.getElementsByName("filter_ui");
  for (i = 0; i < filter_ui_checks.length; i++) {
                filter_ui_checks[i].addEventListener("click",function(){init_hist("hist_div")})
              }

              var sort_ui_checks = document.getElementsByName("sort_ui");
  for (i = 0; i < sort_ui_checks.length; i++) {
                sort_ui_checks[i].addEventListener("click",function(){init_hist("hist_div")})
              }
})();

            // build it !
            init_hist('hist_div');

            $('#UI_hist_collapse').collapse({
    hide: true
})


        }

    }

    function init_table(div_id){

    var tab = $('#' + div_id);
    tab.bootstrapTable({
        url: "{% url 'genomes_json' %}",
        reorderableColumns:true,
        pagination: true,
        pageSize:10,
        showColumns: true,
        search: true,
        showExport: true,
        pageList: [10, 25, 50, 100, "All"],
        mobileResponsive: true,
        checkOnInit: true,
        undefinedText: "",
        idField: 'code',
        showToggle: 'true',

        columns: [{
            field: 'uniprot_species_code',
            title: 'Code'
        }, {
            field: 'sciname',
            title: 'Scientific Name'
        }, {
            field: 'prots',
            title: '# of Sequences'
        },
        {
            field: 'ncbi',
            title: 'NCBI TaxonId'
        },
        {
            field: 'kingdom',
            title: 'Kingdom'
        }]
    });

    var icons = tab.bootstrapTable('getOptions').icons;
    $.extend(icons, {export: 'glyphicon-download-alt', columns: 'glyphicon-list'});
    tab.bootstrapTable('refreshOptions', {'icons': icons});
    }

    // gridlines in y axis function
function make_y_gridlines() {
    return d3.axisLeft(y)
        .ticks(5)
}



    function init_hist(div_id){

        function add_legend(div_id){

            d3.select("svg").remove();

            var margin = {top:10, right:10, bottom:90, left:10};


            var height = 500 - margin.top - margin.bottom;

            // Legend part

            var svgLegend = d3.select("#" + div_id).append("svg")
                    .attr("width", 800)
                    .attr("height",30)
                    .append("g").attr("class", "container")
                    .attr("transform", "translate("+ margin.left +","+ margin.top +")");

                // draw legend
  var legend = svgLegend.selectAll(".legend")
      .data([{
                name: "Archaea",
                color: "#ecf0f1"},
      {
                name: "Bacteria",
                color: "#bdc3c7"},
      {
                name: "Eukaryota",
                color: "#7f8c8d"},
      {
                color: "#2c3e50",
                name: "_default"}])
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(" + i * 100 + ",0 )"; });

  // draw legend colored rectangles
  legend.append("rect")
      .attr("x",  18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", function(d){return d.color});

  // draw legend text
  legend.append("text")
      .attr("x",  40)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "start")
      .text(function(d) { return d.name;})

                }

        d3.select("svg").remove();


        add_legend("hist_legend");


        d3.json("{% url 'genomes_json' %}", function(error, data) {
            if (error) throw error;


            // filter by kingdom
            var filter_arr = [];
            var filter_ui_checkbox = document.getElementsByName("filter_ui");
            for (i = 0; i < filter_ui_checkbox.length; i++) {
                if (filter_ui_checkbox[i].checked){filter_arr.push(filter_ui_checkbox[i].value)}
              }
            data = filterJSON(data,"kingdom", filter_arr );

            //sort by size or kingdom
            var sortBy;
            var sort_ui_checkbox = document.getElementsByName("sort_ui");
            for (i = 0; i < sort_ui_checkbox.length; i++) {
                if (sort_ui_checkbox[i].checked){sortBy=sort_ui_checkbox[i].value}
              }
            data.sort(function(x, y){
                return d3.descending(x[sortBy], y[sortBy]);
            })

            var margin = {top:10, right:10, bottom:90, left:10};

            var width = (data.length)*10 - margin.left - margin.right;

            var height = 500 - margin.top - margin.bottom;

            var xScale = d3.scale.ordinal().rangeBands([0, width], .03)

            var yScale = d3.scale.linear()
                .range([height, 0]);

            var xAxis = d3.svg.axis()
                    .scale(xScale)
                    .orient("bottom");

            var yAxis = d3.svg.axis()
                    .scale(yScale)
                    .orient("left");



            var color_cases =  {
                Bacteria: "#bdc3c7",
                Archaea: "#ecf0f1",
                Eukaryota: "#7f8c8d",
                _default: "#2c3e50"};

            // add the tooltip area to the webpage
            var tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);



            var svgContainer = d3.select("#" + div_id).append("svg")
                    .attr("width", width+margin.left + margin.right)
                    .attr("height",height+margin.top + margin.bottom)
                    .append("g").attr("class", "container")
                    .attr("transform", "translate("+ margin.left +","+ margin.top +")");


            xScale.domain(data.map(function(d) { return d.uniprot_species_code; }));
            yScale.domain([0, d3.max(data, function(d) { return d.prots; })]);


            function make_y_axis() {

            return d3.svg.axis()
                .scale(yScale)
                .orient("left")
                .ticks(10)
                    }



            var xAxis_g = svgContainer.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + (height) + ")")
                    .call(xAxis)
                    .selectAll("text")
                    .attr("y", 0)
                    .attr("x", 9)
                    .attr("dy", ".35em")
                    .attr("transform", "rotate(90)")
                    .style("text-anchor", "start");


            svgContainer.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", function(d) { return xScale(d.uniprot_species_code); })
                .attr("width", xScale.rangeBand())
                .attr("y", function(d) { return yScale(d.prots); })
                .attr("fill", function(d){return color_cases[d.kingdom] ? color_cases[d.kingdom] : color_cases['_default']})
                .attr("height", function(d) { return height - yScale(d.prots)})
                .on("mouseover", function(d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .95);
                    tooltip.html( d.sciname + "</br><b>" + d.uniprot_species_code
                        + ", " + d.prots + "</b>")
                        .style("left", (d3.event.pageX + 5) + "px")
                        .style("top", (d3.event.pageY - 60) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });


            var yAxis_g = svgContainer.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .selectAll("text")
                    .attr("y", 0)
                    .attr("x", 9)
                    .attr("dy", "-.15em")
                    .attr("transform", "rotate(-90)")
                    .style("text-anchor", "end");

                svgContainer.append("g")
        .attr("class", "grid")
        .call(make_y_axis()
            .tickSize(-width, 0, 0)
            .tickFormat("")
        )

            function add_legend(div_id){

            // Legend part

            var svgLegend = d3.select("#" + div_id).append("svg")
                    .attr("width", 800)
                    .attr("height",100)
                    .append("g").attr("class", "container")
                    .attr("transform", "translate("+ margin.left +","+ margin.top +")");

                // draw legend
  var legend = svgContainer.selectAll(".legend")
      .data([{
                name: "Archaea",
                color: "#ecf0f1"},
      {
                name: "Bacteria",
                color: "#bdc3c7"},
      {
                name: "Eukaryota",
                color: "#7f8c8d"},
      {
                color: "#2c3e50",
                name: "_default"}])
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  // draw legend colored rectangles
  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", function(d){return d.color});

  // draw legend text
  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d.name;})

                }

        })






    }

    function filterJSON(json, key, values) {
              var result = [];
              for (i = 0; i < json.length; i++) {
                if   (values.indexOf(json[i][key]) > -1) {
                //if (json[i][key] === value) {
                  result.push(json[i]);
                }
              }
              return result;
            }





</script>


{% endblock content %}
