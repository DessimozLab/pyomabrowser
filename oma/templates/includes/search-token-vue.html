{% load staticfiles %}

<script src="{% static 'js/vue.js' %}"></script>

<style>

    .prefix-dropdown {
        border: none;
        background-color: transparent;
    }

    .vl {
        border-left: 2px solid grey;
        margin-left: 4px;
        margin-right: 4px;
    }

    .token-input {
        width: 100%;
        border: 1px solid #eee;
        font-size: 0.9em;
        height: 50px;
        box-sizing: border-box;
        padding: 0 10px;
    }

    .token-input__tag {
        height: 30px;
        float: left;
        margin-right: 10px;
        background-color: #eee;
        margin-top: 10px;
        line-height: 30px;
        padding: 0 5px;
        border-radius: 5px;
    }

    .token-input__tag > span {
        cursor: pointer;
        opacity: 0.75;
    }

    .token-input__text {
        border: none;
        outline: none;
        font-size: 0.9em;
        line-height: 50px;
        background: none;
    }

    .token-delete{
        margin-left: 4px ;
        color: red;
    }

</style>


<script type="module">

    const {createApp} = Vue

    createApp({
        data() {
            return {
                tokens: [{query: 'HUMAN', single_term: true, prefix: "Species"}],
                prefixes: [{handle: 'Sequence'},{handle: 'HOG'},{handle: 'Species'},  ]
            }
        },
        compilerOptions: {
            delimiters: ["$[", "]$"]
        },
        methods: {
            addToken(event) {

                event.preventDefault()
                var val = event.target.value.trim()

                var sinle_term = val[0] != '"';
                var multi_term_closed = val[val.length-1] == '"'
                var has_prefix = val.includes(':')
                var prefix_end = val[val.length-1] == ':'

                if (val.length > 0) {

                    if (!sinle_term){
                         if (!multi_term_closed ){

                              if (event.code == "Space"){
                                 event.target.value = val + ' '
                              }
                             return
                         }
                    }

                    if (prefix_end){
                        return
                    }


                    var q = has_prefix ? val.split(':')[1] : val
                    var p = has_prefix ? val.split(':')[0] : ""



                    this.tokens.push({query: q, single_term: sinle_term, prefix: p})
                    event.target.value = ''
                }
            },
            removeToken(index) {
                this.tokens.splice(index, 1)
            },
            removeLastToken(event) {
                if (event.target.value.length === 0) {
                    this.removeToken(this.tokens.length - 1)
                }
            }
        },
    }).mount('#token-input')


</script>


<div id="token-input">

    <div v-for="token, index in tokens" :key="token" class="token-input__tag">

        <select class="prefix-dropdown">
            <option v-for="prefix in prefixes" :key="prefix" :selected= "prefix.handle == token.prefix">
                $[ prefix.handle ]$
            </option>
        </select>

        <span class="vl"></span>

        $[ token.query ]$

        <span @click='removeToken(index)'  class="token-delete">X</span>

        </select>

    </div>

        <input type='text' placeholder="Enter your query" class='token-input__text'
               @keydown.enter='addToken'
               @keydown.space='addToken'
               @keydown.delete='removeLastToken'
        />


</div>